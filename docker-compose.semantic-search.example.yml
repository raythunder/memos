name: memos-semantic-search

services:
  # Optional local PostgreSQL. Keep this service when running fully local.
  # If you use Supabase, this container can stay stopped.
  postgres:
    image: postgres:16
    container_name: memos-postgres
    environment:
      POSTGRES_USER: memos
      POSTGRES_PASSWORD: memos
      POSTGRES_DB: memos
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U memos -d memos"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  memos:
    image: ${MEMOS_IMAGE:-neosmemo/memos:stable}
    container_name: memos
    ports:
      - "5230:5230"
    environment:
      MEMOS_DRIVER: postgres
      # Default DSN points to local postgres service.
      # Override with Supabase DSN in .env when needed.
      MEMOS_DSN: ${MEMOS_DSN:-postgres://memos:memos@postgres:5432/memos?sslmode=disable}
      # Optional Supabase Auth integration (hybrid mode).
      # Example: https://<project-ref>.supabase.co
      MEMOS_SUPABASE_PROJECT_URL: ${MEMOS_SUPABASE_PROJECT_URL:-}
      MEMOS_SUPABASE_JWT_AUDIENCE: ${MEMOS_SUPABASE_JWT_AUDIENCE:-authenticated}
      MEMOS_PORT: 5230
      # Optional environment fallback. You can also set these in Settings -> AI.
      MEMOS_OPENAI_API_KEY: ${MEMOS_OPENAI_API_KEY:-}
      MEMOS_OPENAI_BASE_URL: ${MEMOS_OPENAI_BASE_URL:-https://api.openai.com/v1}
      MEMOS_OPENAI_EMBEDDING_MODEL: ${MEMOS_OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
    volumes:
      - memos-data:/var/opt/memos
    restart: unless-stopped

volumes:
  postgres-data:
  memos-data:
